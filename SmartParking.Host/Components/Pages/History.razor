@page "/admin/history"
@rendermode InteractiveServer

@using SmartParking.Application.Contracts
@inject SmartParking.Application.Services.ITelemetryLogService TelemetryLogService

<h3>Telemetry History</h3>

<div style="display:flex; gap:10px; align-items:end; flex-wrap:wrap; margin-bottom:12px;">
    <div>
        <label>DeviceCode</label>
        <input class="form-control" @bind="_deviceCode" />
    </div>
    <div>
        <label>SlotLabel</label>
        <input class="form-control" @bind="_slotLabel" />
    </div>
    <div>
        <label>Take</label>
        <input class="form-control" type="number" min="1" max="500" @bind="_take" />
    </div>
    <button class="btn btn-primary" @onclick="Load">Load</button>
</div>

@if (_items is null)
{
    <p>Loading...</p>
}
else
{
    <table class="table">
        <thead>
        <tr>
            <th>Received (UTC)</th>
            <th>Device</th>
            <th>Sensor</th>
            <th>Slot</th>
            <th>Distance</th>
            <th>Status</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var x in _items)
        {
            <tr>
                <td>@x.ReceivedAtUtc.ToString("u")</td>
                <td>@x.DeviceCode</td>
                <td>@x.SensorCode</td>
                <td>@x.SlotLabel</td>
                <td>@x.DistanceCm</td>
                <td>@x.StatusAfter</td>
            </tr>
        }
        </tbody>
    </table>
}
@code {
    private List<TelemetryLogDto>? _items;

    private string? _deviceCode;
    private string? _slotLabel;
    private int _take = 100;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        _items = await TelemetryLogService.GetRecentAsync(_take, _slotLabel, _deviceCode, CancellationToken.None);
    }
}
