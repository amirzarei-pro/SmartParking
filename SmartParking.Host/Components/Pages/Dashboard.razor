@page "/"
@rendermode InteractiveServer
@using SmartParking.Application.Services
@using SmartParking.Application.Contracts
@inject ISlotService SlotService
@inject IDeviceService DeviceService
@inject ITelemetryLogService TelemetryLogService
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Dashboard - Smart Parking</PageTitle>

@if (_loading)
{
    <div class="loading-overlay">
        <div class="spinner"></div>
        <p>Loading dashboard...</p>
    </div>
}
else
{
    <div class="panel glass" style="margin-bottom: 1.5rem;">
        <div class="panel__head">
            <h2 class="panel__title">Slot Occupancy Time (@_selectedDate.ToString("MMM dd, yyyy"))</h2>
            <div class="panel__actions" style="display: flex; align-items: center; gap: 1rem;">
                <input type="date" class="date-input" value="@_selectedDate.ToString("yyyy-MM-dd")" 
                       max="@DateOnly.FromDateTime(DateTime.Today).ToString("yyyy-MM-dd")"
                       @onchange="OnDateChangedAsync" />
                @if (_selectedDate == DateOnly.FromDateTime(DateTime.Today))
                {
                    <div class="pill pill--info"><span class="dot dot--pulse"></span> Live</div>
                }
                else
                {
                    <div class="pill pill--muted">Historical</div>
                }
            </div>
        </div>
        <div class="chart-wrap" style="height: 320px;">
            <canvas id="chartLine"></canvas>
        </div>
        <div class="panel__foot">
            <div class="mini">
                <div class="mini__k">Most Occupied Slot</div>
                <div class="mini__v" id="peakHour">@_peakHour</div>
            </div>
            <div class="mini">
                <div class="mini__k">Avg occupancy</div>
                <div class="mini__v" id="avgOcc">@_avgOccupancy</div>
            </div>
        </div>
    </div>

    <div class="grid-2" style="margin-bottom: 1.5rem;">
        <div class="panel glass">
            <div class="panel__head">
                <h2 class="panel__title">Key Metrics</h2>
                <div class="panel__actions">
                    <button class="btn btn--primary" @onclick="RefreshDataAsync">Refresh</button>
                </div>
            </div>

            <div class="kpis">
                <div class="kpi">
                    <div class="kpi__label">Total Slots</div>
                    <div class="kpi__value" id="kpiTotal">@_totalSlots</div>
                    <div class="kpi__hint">Configured parking spots</div>
                </div>

                <div class="kpi">
                    <div class="kpi__label">Occupied</div>
                    <div class="kpi__value kpi__value--danger" id="kpiOcc">@_occupiedSlots</div>
                    <div class="kpi__hint">Live occupancy</div>
                </div>

                <div class="kpi">
                    <div class="kpi__label">Free</div>
                    <div class="kpi__value kpi__value--success" id="kpiFree">@_freeSlots</div>
                    <div class="kpi__hint">Available now</div>
                </div>

                <div class="kpi">
                    <div class="kpi__label">Devices Online</div>
                    <div class="kpi__value" id="kpiOnline">@_devicesOnline</div>
                    <div class="kpi__hint">IoT heartbeat OK</div>
                </div>
            </div>
        </div>

        <div class="panel glass">
            <div class="panel__head">
                <h2 class="panel__title">Live Distribution</h2>
                <div class="panel__sub">Free vs Occupied vs Offline</div>
            </div>
            <div class="chart-wrap">
                <canvas id="chartDonut" height="200" width="200" style="display: block; box-sizing: border-box; max-height: 200px;"></canvas>
            </div>
            <div class="legend">
                <div class="legend__item"><span class="swatch swatch--free"></span> Free (@_freeSlots)</div>
                <div class="legend__item"><span class="swatch swatch--occ"></span> Occupied (@_occupiedSlots)</div>
                <div class="legend__item"><span class="swatch swatch--off"></span> Offline (@_offlineSlots)</div>
            </div>
        </div>
    </div>

    <div class="grid-2" style="margin-bottom: 1.5rem;">
        <div class="panel glass">
            <div class="panel__head">
                <h2 class="panel__title">Latest Events</h2>
                <button class="btn btn--ghost" data-route-jump="logs">View all</button>
            </div>
            <div class="feed" id="eventFeed">
                @if (_recentLogs.Count == 0)
                {
                    <div class="event">
                        <div class="event__left">
                            <div class="event__title">No recent events</div>
                            <div class="event__meta">Waiting for telemetry data...</div>
                        </div>
                    </div>
                }
                else
                {
                    @foreach (var log in _recentLogs)
                    {
                        <div class="event">
                            <div class="event__left">
                                <div class="event__title">@log.SlotLabel updated by @log.DeviceCode/@log.SensorCode</div>
                                <div class="event__meta">Telemetry â€¢ @log.ReceivedAtUtc.ToString("MMM dd, HH:mm")</div>
                            </div>
                            <div class="badge @GetBadgeClass(log.StatusAfter)">@log.StatusAfter.ToUpper()</div>
                        </div>
                    }
                }
            </div>
        </div>

        <div class="panel glass">
            <div class="panel__head">
                <h2 class="panel__title">System Health</h2>
                <div class="pill pill--ok"><span class="dot dot--online"></span> OK</div>
            </div>
            <div class="health">
                <div class="health__row">
                    <div class="health__k">Total Devices</div>
                    <div class="health__v">@_totalDevices</div>
                </div>
                <div class="health__row">
                    <div class="health__k">SignalR</div>
                    <div class="health__v"><span class="pill pill--info">Ready</span></div>
                </div>
                <div class="health__row">
                    <div class="health__k">Database</div>
                    <div class="health__v"><span class="pill pill--info">Connected</span></div>
                </div>
            </div>

            <div class="divider"></div>

            <div class="actions">
                <button class="btn btn--primary" @onclick="RefreshDataAsync">Refresh Data</button>
            </div>
        </div>
    </div>

    <div class="panel glass" style="margin-bottom: 1.5rem;">
        <div class="panel__head">
            <h2 class="panel__title">Slots Overview</h2>
            <div class="panel__actions">
                <div class="seg">
                    <button class="seg__btn @(_filter == "all" ? "is-active" : "")" @onclick="@(() => SetFilter("all"))">All</button>
                    <button class="seg__btn @(_filter == "free" ? "is-active" : "")" @onclick="@(() => SetFilter("free"))">Free</button>
                    <button class="seg__btn @(_filter == "occupied" ? "is-active" : "")" @onclick="@(() => SetFilter("occupied"))">Occupied</button>
                    <button class="seg__btn @(_filter == "offline" ? "is-active" : "")" @onclick="@(() => SetFilter("offline"))">Offline</button>
                </div>
            </div>
        </div>

        <div class="table">
            <div class="table__head">
                <div class="table__row table__row--head">
                    <div class="cell cell--w120">Slot</div>
                    <div class="cell">Zone</div>
                    <div class="cell cell--w160">Status</div>
                    <div class="cell cell--w160">Distance</div>
                    <div class="cell cell--w200">Last Update</div>
                    <div class="cell cell--w160">Device</div>
                    <div class="cell cell--w140">Threshold</div>
                </div>
            </div>
            <div class="table__body" id="slotsTable">
                @if (FilteredSlots.Count == 0)
                {
                    <div class="table__row">
                        <div class="cell" colspan="7">No slots found</div>
                    </div>
                }
                else
                {
                    @foreach (var slot in FilteredSlots)
                    {
                        <div class="table__row">
                            <div class="cell" data-label="Slot">@slot.Label</div>
                            <div class="cell cell--muted" data-label="Zone">@slot.Zone</div>
                            <div class="cell" data-label="Status">
                                <span class="badge @GetBadgeClass(slot.Status)">@slot.Status.ToUpper()</span>
                            </div>
                            <div class="cell cell--muted" data-label="Distance">@slot.LastDistanceCm.ToString("F1") cm</div>
                            <div class="cell cell--muted" data-label="Last Update">@slot.LastUpdateAt.ToString("MMM dd, HH:mm")</div>
                            <div class="cell cell--muted" data-label="Device">@(slot.DeviceCode ?? "N/A")/@(slot.SensorCode ?? "N/A")</div>
                            <div class="cell cell--muted" data-label="Threshold">@slot.OccupiedThresholdCm cm</div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
}

@code {
    private bool _loading = true;
    private bool _chartsInitialized = false;
    private List<SlotDto> _slots = new();
    private List<DeviceDto> _devices = new();
    private List<TelemetryLogDto> _recentLogs = new();
    private List<SlotHourlyOccupancyDto> _slotHourlyOccupancy = new();
    private string _filter = "all";
    private IJSObjectReference? _chartModule;
    private DateOnly _selectedDate = DateOnly.FromDateTime(DateTime.Today);

    // Computed metrics
    private int _totalSlots => _slots.Count;
    private int _freeSlots => _slots.Count(s => s.Status.Equals("Free", StringComparison.OrdinalIgnoreCase));
    private int _occupiedSlots => _slots.Count(s => s.Status.Equals("Occupied", StringComparison.OrdinalIgnoreCase));
    private int _offlineSlots => _slots.Count(s => s.Status.Equals("Offline", StringComparison.OrdinalIgnoreCase));
    private int _totalDevices => _devices.Count;
    private int _devicesOnline => _devices.Count(d => d.LastSeenAt > DateTimeOffset.Now.AddMinutes(-5));

    private string _peakHour = "N/A";
    private string _avgOccupancy => _totalSlots > 0 
        ? $"{(_occupiedSlots * 100.0 / _totalSlots):F0}%" 
        : "0%";

    private List<SlotDto> FilteredSlots => _filter switch
    {
        "free" => _slots.Where(s => s.Status.Equals("Free", StringComparison.OrdinalIgnoreCase)).ToList(),
        "occupied" => _slots.Where(s => s.Status.Equals("Occupied", StringComparison.OrdinalIgnoreCase)).ToList(),
        "offline" => _slots.Where(s => s.Status.Equals("Offline", StringComparison.OrdinalIgnoreCase)).ToList(),
        _ => _slots
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_loading && !_chartsInitialized)
        {
            _chartsInitialized = true;
            await InitializeChartsAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        try
        {
            _slots = await SlotService.GetAllAsync(CancellationToken.None);
            _devices = await DeviceService.GetAllAsync(CancellationToken.None);
            _recentLogs = await TelemetryLogService.GetRecentAsync(5, null, null, CancellationToken.None);
            _slotHourlyOccupancy = await TelemetryLogService.GetSlotHourlyOccupancyAsync(_selectedDate, CancellationToken.None);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard data: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task InitializeChartsAsync()
    {
        try
        {
            var chartData = new
            {
                free = _freeSlots,
                occupied = _occupiedSlots,
                offline = _offlineSlots,
                total = _totalSlots
            };
            
            // Prepare slot hourly occupancy data for the multi-line chart
            var slotHourlyData = _slotHourlyOccupancy.Select(s => new
            {
                slotLabel = s.SlotLabel,
                hourlyMinutes = s.HourlyOccupancyMinutes.Select(m => Math.Round(m, 1)).ToArray()
            }).ToArray();
            
            var result = await JS.InvokeAsync<ChartResult>("smartParkingCharts.initCharts", chartData, slotHourlyData);
            if (result != null)
            {
                _peakHour = result.PeakHour ?? "N/A";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing charts: {ex.Message}");
        }
    }

    private async Task RefreshDataAsync()
    {
        _chartsInitialized = false;
        await LoadDataAsync();
        StateHasChanged();
    }

    private void SetFilter(string filter)
    {
        _filter = filter;
    }

    private async Task OnDateChangedAsync(ChangeEventArgs e)
    {
        if (DateOnly.TryParse(e.Value?.ToString(), out var newDate))
        {
            _selectedDate = newDate;
            _chartsInitialized = false;
            _slotHourlyOccupancy = await TelemetryLogService.GetSlotHourlyOccupancyAsync(_selectedDate, CancellationToken.None);
            StateHasChanged();
        }
    }

    private static string GetBadgeClass(string status) => status.ToLowerInvariant() switch
    {
        "free" => "badge--free",
        "occupied" => "badge--occ",
        "offline" => "badge--off",
        _ => "badge--free"
    };

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("smartParkingCharts.destroyCharts");
        }
        catch
        {
            // Ignore disposal errors
        }

        if (_chartModule is not null)
        {
            await _chartModule.DisposeAsync();
        }
    }

    private class ChartResult
    {
        public string? PeakHour { get; set; }
        public int AvgOccupancy { get; set; }
    }
}