@page "/live"
@rendermode InteractiveServer
@using SmartParking.Application.Services
@using SmartParking.Application.Contracts
@using Microsoft.AspNetCore.SignalR.Client
@inject ISlotService SlotService
@inject NavigationManager NavigationManager
@implements IAsyncDisposable

<PageTitle>Live Parking - Smart Parking</PageTitle>

<div class="grid-2">
    <div class="panel glass">
        <div class="panel__head">
            <h2 class="panel__title">Live Parking Map</h2>
            <div class="pill pill--@hubStatusClass"><span class="dot dot--@hubStatusDot"></span> @hubStatus</div>
        </div>

        <div class="map">
            <div class="map__header">
                <div class="pill pill--info"><span class="dot dot--pulse"></span> Real-time</div>
                <div class="filter-zone">
                    <label for="zoneFilter">Zone:</label>
                    <select id="zoneFilter" @bind="selectedZone" @bind:after="OnZoneFilterChanged">
                        <option value="">All Zones</option>
                        @foreach (var zone in availableZones)
                        {
                            <option value="@zone">@zone</option>
                        }
                    </select>
                </div>
                <div class="map__meta">
                    @if (selectedSlot is not null)
                    {
                        <span>@selectedSlot.DeviceCode ‚Ä¢ Sensors: @filteredSlots.Count(s => s.DeviceCode == selectedSlot.DeviceCode)</span>
                    }
                    else
                    {
                        <span>Showing: @filteredSlots.Count / @slots.Count slots</span>
                    }
                </div>
            </div>

            <div class="slot-map" id="slotMap">
                @if (slots.Count == 0)
                {
                    <div class="hint">Loading slots...</div>
                }
                else
                {
                    @foreach (var slot in filteredSlots)
                    {
                        var statusClass = slot.Status.ToLower();
                        var isSelected = selectedSlot?.Label == slot.Label;
                        var outlineStyle = isSelected ? "outline: rgba(79, 195, 255, 0.55) solid 2px;" : "outline: none;";
                        var canDelete = slot.SensorCode is null;

                        <div class="slot-tile @statusClass" 
                             data-id="@slot.Label"
                             style="@outlineStyle; cursor: pointer; position: relative;"
                             @onclick="() => SelectSlot(slot)">
                            @if (canDelete)
                            {
                                <button class="btn-delete-slot" 
                                        title="Delete slot"
                                        @onclick="() => ConfirmDeleteSlot(slot.Label)"
                                        @onclick:stopPropagation="true">
                                    üóëÔ∏è
                                </button>
                            }
                            <div class="slot-tile__id">@slot.Label</div>
                            <div class="slot-tile__sub">@(slot.DeviceCode ?? "‚Äî")/@(slot.SensorCode ?? "‚Äî")</div>
                            <div class="slot-tile__sub">@slot.LastDistanceCm cm ‚Ä¢ @slot.LastUpdateAt.ToString("MMM dd, HH:mm")</div>
                        </div>
                    }
                }
            </div>

            <div class="map__footer">
                <div class="hint">
                    @if (!string.IsNullOrEmpty(lastUpdate))
                    {
                        <span>Last update: @lastUpdate</span>
                    }
                    else
                    {
                        <span>Waiting for updates...</span>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="panel glass">
        <div class="panel__head">
            <h2 class="panel__title">Slot Details</h2>
            @if (selectedSlot is not null)
            {
                <div class="pill pill--info" id="slotDetailPill">@selectedSlot.Label ‚Ä¢ @selectedSlot.Status.ToUpper()</div>
            }
            else
            {
                <div class="pill pill--info" id="slotDetailPill">Select a slot</div>
            }
        </div>

        <div class="details" id="slotDetails">
            @if (selectedSlot is not null)
            {
                <div class="details__box">
                    <div class="details__row">
                        <div class="details__k">Slot</div>
                        <div class="details__v">@selectedSlot.Label</div>
                    </div>
                    <div class="details__row">
                        <div class="details__k">Zone</div>
                        <div class="details__v">@selectedSlot.Zone</div>
                    </div>
                    <div class="details__row">
                        <div class="details__k">Device</div>
                        <div class="details__v">@selectedSlot.DeviceCode</div>
                    </div>
                    <div class="details__row">
                        <div class="details__k">Sensor Channel</div>
                        <div class="details__v">@selectedSlot.SensorCode</div>
                    </div>
                    <div class="details__row">
                        <div class="details__k">Status</div>
                        <div class="details__v"><span class="badge badge--@selectedSlot.Status.ToLower()">@selectedSlot.Status.ToUpper()</span></div>
                    </div>
                    <div class="details__row">
                        <div class="details__k">Distance</div>
                        <div class="details__v">@selectedSlot.LastDistanceCm cm</div>
                    </div>
                    <div class="details__row">
                        <div class="details__k">Threshold</div>
                        <div class="details__v">@selectedSlot.OccupiedThresholdCm cm</div>
                    </div>
                    <div class="details__row">
                        <div class="details__k">Last Update</div>
                        <div class="details__v">@selectedSlot.LastUpdateAt.ToString("MMM dd, HH:mm")</div>
                    </div>
                </div>
            }
            else
            {
                <div class="details__box">
                    <p style="text-align: center; color: #999;">Select a slot to view details</p>
                </div>
            }
        </div>

        <div class="divider"></div>

        <div class="actions">
            <button class="btn btn--primary" id="btnForceRefresh" @onclick="RefreshSlots">Force Refresh</button>
        </div>
    </div>
</div>

@if (showDeleteConfirm)
{
    <div class="modal-overlay" @onclick="CancelDelete">
        <div class="modal-dialog" @onclick:stopPropagation="true">
            <h3>Delete Slot</h3>
            <p>Are you sure you want to delete slot <strong>@slotToDelete</strong>?</p>
            <div class="modal-actions">
                <button class="btn btn--secondary" @onclick="CancelDelete">Cancel</button>
                <button class="btn btn--danger" @onclick="DeleteSlot">Delete</button>
            </div>
        </div>
    </div>
}

<style>
    .filter-zone {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .filter-zone label {
        color: #aaa;
        font-size: 13px;
    }
    .filter-zone select {
        background: #2a2a3e;
        color: #fff;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 13px;
        cursor: pointer;
    }
    .filter-zone select:focus {
        outline: none;
        border-color: #4fc3ff;
    }
    .btn-delete-slot {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(255, 100, 100, 0.2);
        border: none;
        border-radius: 4px;
        padding: 2px 6px;
        cursor: pointer;
        font-size: 12px;
        opacity: 0.7;
        transition: opacity 0.2s, background 0.2s;
    }
    .btn-delete-slot:hover {
        opacity: 1;
        background: rgba(255, 100, 100, 0.5);
    }
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .modal-dialog {
        background: #1e1e2e;
        border-radius: 12px;
        padding: 24px;
        min-width: 320px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    .modal-dialog h3 {
        margin: 0 0 12px 0;
        color: #fff;
    }
    .modal-dialog p {
        margin: 0 0 20px 0;
        color: #aaa;
    }
    .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }
    .btn--secondary {
        background: #444;
        color: #fff;
    }
    .btn--danger {
        background: #e74c3c;
        color: #fff;
    }
    .btn--danger:hover {
        background: #c0392b;
    }
</style>

@code {
    private List<SlotDto> slots = new();
    private SlotDto? selectedSlot;
    
    // SignalR state
    private HubConnection? hubConnection;
    private string hubStatus = "Disconnected";
    private string hubStatusClass = "offline";
    private string hubStatusDot = "offline";
    private string lastUpdate = "";
    
    // Delete confirmation state
    private bool showDeleteConfirm = false;
    private string? slotToDelete = null;
    
    // Zone filter state
    private string selectedZone = "";
    private List<string> availableZones = new();
    private List<SlotDto> filteredSlots => string.IsNullOrEmpty(selectedZone) 
        ? slots 
        : slots.Where(s => s.Zone == selectedZone).ToList();

    protected override async Task OnInitializedAsync()
    {
        await RefreshSlots();
        await InitializeSignalR();
    }

    private void OnZoneFilterChanged()
    {
        // Clear selection if selected slot is not in filtered list
        if (selectedSlot is not null && !filteredSlots.Any(s => s.Label == selectedSlot.Label))
        {
            selectedSlot = filteredSlots.FirstOrDefault();
        }
    }

    private async Task InitializeSignalR()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/parking"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.Reconnecting += _ =>
        {
            hubStatus = "Reconnecting...";
            hubStatusClass = "warn";
            hubStatusDot = "offline";
            return InvokeAsync(StateHasChanged);
        };

        hubConnection.Reconnected += _ =>
        {
            hubStatus = "Connected";
            hubStatusClass = "ok";
            hubStatusDot = "online";
            return InvokeAsync(StateHasChanged);
        };

        hubConnection.Closed += _ =>
        {
            hubStatus = "Disconnected";
            hubStatusClass = "offline";
            hubStatusDot = "offline";
            return InvokeAsync(StateHasChanged);
        };

        hubConnection.On<TelemetryIngestResultDto>("slotUpdated", msg =>
        {
            if (msg.SlotLabel is null) return Task.CompletedTask;

            lastUpdate = $"{msg.SlotLabel} ‚Üí {msg.Status} @ {DateTime.Now:HH:mm:ss}";

            var slot = slots.FirstOrDefault(x => x.Label == msg.SlotLabel);
            if (slot is null) return Task.CompletedTask;

            var idx = slots.IndexOf(slot);
            slots[idx] = slot with
            {
                Status = msg.Status ?? slot.Status,
                LastDistanceCm = msg.DistanceCm ?? slot.LastDistanceCm,
                LastUpdateAt = msg.UpdatedAt ?? slot.LastUpdateAt
            };

            // Update selected slot if it's the one that changed
            if (selectedSlot?.Label == msg.SlotLabel)
            {
                selectedSlot = slots[idx];
            }

            return InvokeAsync(StateHasChanged);
        });

        try
        {
            await hubConnection.StartAsync();
            hubStatus = "Connected";
            hubStatusClass = "ok";
            hubStatusDot = "online";
        }
        catch (Exception ex)
        {
            hubStatus = "Error";
            hubStatusClass = "offline";
            hubStatusDot = "offline";
            Console.WriteLine($"SignalR connection error: {ex.Message}");
        }
    }

    private async Task RefreshSlots()
    {
        try
        {
            slots = await SlotService.GetAllAsync(CancellationToken.None);
            availableZones = slots.Select(s => s.Zone).Distinct().OrderBy(z => z).ToList();
            if (filteredSlots.Count > 0 && selectedSlot is null)
            {
                selectedSlot = filteredSlots[0];
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading slots: {ex.Message}");
        }
    }

    private void SelectSlot(SlotDto slot)
    {
        selectedSlot = slot;
    }

    private void ConfirmDeleteSlot(string label)
    {
        slotToDelete = label;
        showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        slotToDelete = null;
    }

    private async Task DeleteSlot()
    {
        if (slotToDelete is null) return;

        try
        {
            var success = await SlotService.DeleteAsync(slotToDelete, CancellationToken.None);
            if (success)
            {
                slots.RemoveAll(s => s.Label == slotToDelete);
                if (selectedSlot?.Label == slotToDelete)
                {
                    selectedSlot = slots.FirstOrDefault();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting slot: {ex.Message}");
        }
        finally
        {
            showDeleteConfirm = false;
            slotToDelete = null;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}